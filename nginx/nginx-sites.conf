# Place this in the sites-available default file

limit_req_zone              $binary_remote_addr zone=totem:10m rate=5r/s;
map $http_upgrade $connection_upgrade {
    default                  upgrade;
    ''                       close;
}
# 10246 websocket-polkadot-ui
upstream websocket-polkadot-ui {
    server                   127.0.0.1:10246;
}
# 10250 websocket-demo-ui
upstream websocket-demo-ui {
    server                   127.0.0.1:10250;
}
# 9715
upstream node-port-9715 {
    server                   127.0.0.1:9715;
}
# 9716
upstream node-port-9716 {
    server                   127.0.0.1:9716;
}
# 9717
upstream node-port-9717 {
    server                   127.0.0.1:9717;
}
# 9718
upstream node-port-9718 {
    server                   127.0.0.1:9718;
}
# 9719
upstream node-port-9719 {
    server                   127.0.0.1:9719;
}
# 9720
upstream node-port-9720 {
    server                   127.0.0.1:9720;
}
# 9721
upstream node-port-9721 {
    server                   127.0.0.1:9721;
}
# 10244
upstream node-port-10244 {
    server                   127.0.0.1:10244;
}
# 10245
upstream node-port-10245 {
    server                   127.0.0.1:10245;
}

server {
    #                        Http Config
    #                        listen 80 default_server;
    #                        listen [::]:80 default_server;

    #                        SSL Configuration
    #                        listen 443 ssl http2 default_server;
    #                        listen [::]:443 ssl http2 default_server;

    listen                   11111 default_server;
    listen                   [::]:11111 default_server;

    #                        include snippets/ssl-node1.totem.live.conf;
    #                        include snippets/ssl-params.conf;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://websocket-polkadot-ui;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}

server {
    #                        Http Config
    #                        listen 80 default_server;
    #                        listen [::]:80 default_server;

    #                        SSL Configuration
    #                        listen 443 ssl http2 default_server;
    #                        listen [::]:443 ssl http2 default_server;

    listen                   22222 default_server;
    listen                   [::]:22222 default_server;

    #                        include snippets/ssl-node1.totem.live.conf;
    #                        include snippets/ssl-params.conf;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://websocket-demo-ui;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9715 19715
server {
    listen                   19715 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9715;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9716 19716
server {
    listen                   19716 default_server;
    listen                   [::]:19716 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9716;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9717 19717
server {
    listen                   19717 default_server;
    listen                   [::]:19717 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9717;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9718 19718
server {
    listen                   19718 default_server;
    listen                   [::]:19718 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9718;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9719 19719
server {
    listen                   19719 default_server;
    listen                   [::]:19719 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9719;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9720 19720
server {
    listen                   19720 default_server;
    listen                   [::]:19720 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9720;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 9721 19721
server {
    listen                   19721 default_server;
    listen                   [::]:19721 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-9721;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 10244 11244
server {
    listen                   11244 default_server;
    listen                   [::]:11244 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-10244;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
# 10245 11245
server {
    listen                   11245 default_server;
    listen                   [::]:11245 default_server;

    location / {
        limit_req            zone=totem burst=20 nodelay;
        limit_req_status     598;
        proxy_pass           http://node-port-10245;
        proxy_http_version   1.1;
        proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header     Upgrade $http_upgrade;
        proxy_set_header     Connection "Upgrade";
        proxy_set_header     Proxy "";
        proxy_set_header     Host $server_name;
        proxy_set_header     X-Real-IP $remote_addr;
        proxy_set_header     X-Forwarded-Proto $scheme;
    }
}
